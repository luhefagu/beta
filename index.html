<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Balance Hídrico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@8/build/umd.js"></script>
<style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1-px rgba(0, 0, 0, 0.06);
            max-width: 400px;
            width: 90%;
        }

        /* --- Estructura y Estilos de la Tabla --- */
        
        /* Contenedor principal de la tabla. El overflow-x maneja el scroll horizontal. */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Mejora el scroll en dispositivos móviles */
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: #fff;
        }
        
        table {
            border-collapse: collapse;
            width: 100%; /* Permite que la tabla se estire más allá del contenedor si es necesario */
        }

        /* Celdas de encabezado y datos */
        th, td {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 4px 8px;
            min-width: 75px; /* Ancho de columna reducido a 50px */
            white-space: nowrap; /* Evita que los encabezados se envuelvan */
            font-size: 12px;
        }
        th:last-child, td:last-child {
            border-right: none;
        }
        
        /* Encabezados de la tabla: se mantienen fijos al hacer scroll vertical */
        thead th {
            position: sticky;
            top: 0;
            z-index: 40;
            background-color: #f9fafb;
            border-right: 1px solid #e5e7eb;
        }

        /* Encabezado de la columna fija: se mantiene fijo al hacer scroll horizontal */
        .fixed-col-header {
            position: sticky;
            left: 0;
            z-index: 50;
            background-color: #f9fafb;
            min-width: 100px; /* Ancho de la columna fija ajustado */
            max-width: 100px; /* Ancho de la columna fija ajustado */
            white-space: normal;
        }
        
        /* Celda de la columna fija en el cuerpo: se mantiene fija al hacer scroll horizontal */
        .fixed-col-body {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: #fff;
            min-width: 100px; /* Ancho de la columna fija ajustado */
            max-width: 100px; /* Ancho de la columna fija ajustado */
            border-right: 1px solid #e5e7eb;
            white-space: normal;
        }
        
        /* Estilos de celda editables */
        .editable-cell {
            position: relative;
            cursor: pointer;
            text-align: center;
            background-color: #fff;
        }
        .editable-cell-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 32px;
        }
        .editable-cell-volume {
            font-weight: 600;
        }
        .editing-mode {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .editing-mode input {
            padding: 2px 4px;
            font-size: 12px;
            min-width: 100px;
        }
        .save-confirmation {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            color: #10b981;
            font-size: 1.25rem;
        }
        .cumulative-total-column {
            background-color: #e5e7eb;
            font-weight: 600;
            text-align: center;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
        }
        .subtotal-row {
            background-color: #e5e7eb;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
        }
        .subtotal-row-cumulative {
            background-color: #c1c1c1;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-bottom: 1px solid #a3a3a3;
        }
        .total-row {
            background-color: #f1f3f4;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #d1d5db;
        }
        .total-row-cumulative {
            background-color: #c1c1c1;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            border-top: 1px solid #d1d5db;
            border-bottom: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
        }
        .subtotal-ingresos-row {
            background-color: #f1f3f4;
            font-weight: 600;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #d1d5db;
        }
        .subtotal-egresos-row {
            background-color: #f1f3f4;
            font-weight: 600;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #d1d5db;
        }
        .add-item-icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .add-item-icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Ocultar las flechas de los inputs de tipo number */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4">

    <!-- Contenedor principal de la aplicación -->
    <div class="max-w-7xl mx-auto bg-white p-4 rounded-xl shadow-lg">

        <!-- Encabezado de la página (se desplaza con el scroll de la página) -->
        <header class="flex items-center justify-between pb-1 mb-1">
            <!-- Información del paciente -->
            <div class="flex-1">
                <p class="text-sm text-gray-500 mt-1"><span id="patient-name"></span>  <span id="patient-rut"></span></p>
            </div>
            <!-- Espacio para el Título + balance total del día -->
            <div class="flex items-center space-x-4 flex-1 justify-center">
                <h3 class="text-md font-bold text-gray-800">Balance Hídrico</h3>
                <p id="total-balance-display" class="text-sm font-bold text-gray-800 mt-1"></p>
            </div>
            <!-- Navegación por días -->
            <div class="flex-1 text-right">
                <button id="prev-day-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-0 px-2 rounded-md text-base">«</button>
                <span id="date-range" class="text-sm font-semibold text-gray-700"></span>
                <button id="next-day-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-0 px-2 rounded-md text-base">»</button>

            </div>
        </header>

        <!-- Contenedor único de la tabla, con el scroll horizontal -->
        <div class="table-container">
            <table class="w-full text-sm text-left text-gray-500">
                <thead class="text-xs text-gray-700 uppercase">
                    <tr id="table-headers">
                        <th scope="col" class="px-2 py-1 border-r border-gray-200 fixed-col-header">Ítem</th>
                        <!-- Encabezados de periodos y totales generados por JS -->
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Filas de datos generadas por JS -->
                </tbody>
            </table>
        </div>

        <!-- Modales de la aplicación -->
        <div id="add-row-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4">Añadir Ítem</h3>
                <p class="mb-2">Ingresa el nombre del nuevo ítem:</p>
                <input type="text" id="new-row-name-input" class="w-full p-2 border rounded-md mb-4" placeholder="Ej: Vómitos">
                <ul id="autocomplete-list" class="absolute w-full bg-white border rounded-md shadow-lg z-10 hidden"></ul>
                <div class="flex justify-end space-x-4 mt-4">
                    <button id="add-row-confirm-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">Añadir</button>
                    <button id="add-row-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="delete-row-modal" class="modal">
            <div class="modal-content text-center">
                <h3 class="text-xl font-bold mb-4 text-red-600">Confirmar Eliminación</h3>
                <p class="mb-4">¿Estás seguro de que deseas eliminar el ítem "<span id="row-to-delete-name"></span>"?</p>
                <p class="text-sm text-gray-500 mb-6" id="delete-row-warning">Este ítem contiene datos para este período. La información se perderá.</p>
                <div class="flex justify-center space-x-4">
                    <button id="delete-row-confirm-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Eliminar</button>
                    <button id="delete-row-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancelar</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // La biblioteca `idb` se carga globalmente, por lo que podemos acceder a `idb` directamente.
        const { openDB } = idb;

        // ===============================================
        //  CONSTANTES Y ESTRUCTURA DE DATOS
        // ===============================================
        const tableHeadersEl = document.getElementById('table-headers');
        const tableBodyEl = document.getElementById('table-body');
        const dateRangeEl = document.getElementById('date-range');
        const prevDayBtn = document.getElementById('prev-day-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const totalBalanceDisplay = document.getElementById('total-balance-display');

        // Periodos de registro por hora
        const periodos = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00', '20:00', '21:00', '22:00', '23:00', '00:00', '01:00', '02:00', '03:00', '04:00', '05:00', '06:00', '07:00'];
        const itemsIngresosBase = ['Ingesta Oral', 'Medicamentos'];
        const itemsEgresosBase = ['Orina', 'Deposiciones'];
        const patientData = {
            rut: '12.345.678-9',
            nombre: 'Juan Pérez'
        };

        const cumulativeCheckpoints = ['13:00', '19:00', '01:00', '07:00'];
        const closedCumulativeCheckpoints = ['13:00', '19:00', '01:00', '07:00'];
        const cumulativeTitles = {
            '13:00': '07 - 13 hrs',
            '19:00': '07 - 19 hrs',
            '01:00': '07 - 01 hrs',
            '07:00': '07 - 07 hrs'
        };

        let db;
        let currentDate = new Date();
        let customItems = { ingresos: [], egresos: [] };
        let currentDayData = {};
        let autocompleteNames = ['Diálisis', 'Vómitos', 'Sonda Nasogástrica', 'Drenaje', 'Fístula'];

        // ===============================================
        //  MODALES
        // ===============================================
        const addRowModal = document.getElementById('add-row-modal');
        const deleteRowModal = document.getElementById('delete-row-modal');
        const addRowNameInput = document.getElementById('new-row-name-input');
        const autocompleteList = document.getElementById('autocomplete-list');
        let currentAddRowType = '';
        let rowToDelete = null;

        function openModal(modal) { modal.style.display = 'flex'; }
        function closeModal(modal) { modal.style.display = 'none'; }
        
        function openAddRowModal(type) {
            currentAddRowType = type;
            addRowNameInput.value = '';
            autocompleteList.innerHTML = '';
            openModal(addRowModal);
        }

        function openDeleteRowModal(rowName, rowType) {
            rowToDelete = { name: rowName, type: rowType };
            document.getElementById('row-to-delete-name').textContent = rowName;
            
            const hasData = periodos.some(periodo => {
                const data = currentDayData[periodo]?.[rowType]?.[rowName];
                return data && (data.volumen > 0 || data.comentario);
            });

            document.getElementById('delete-row-warning').style.display = hasData ? 'block' : 'none';
            openModal(deleteRowModal);
        }

        // ===============================================
        //  PERSISTENCIA DE DATOS (INDEXEDDB)
        // ===============================================
        const DB_NAME = 'balanceHidricoDBTranspuesta';
        const DB_VERSION = 1;
        const STORE_PACIENTES = 'pacientes';
        const STORE_DIAS = 'dias';

        async function initDB() {
            try {
                db = await openDB(DB_NAME, DB_VERSION, {
                    upgrade(db, oldVersion) {
                        if (oldVersion < 1) {
                            db.createObjectStore(STORE_PACIENTES, { keyPath: 'rut' });
                            db.createObjectStore(STORE_DIAS, { keyPath: 'id' });
                        }
                    },
                });
            } catch (error) {
                console.error('Error al inicializar la base de datos:', error);
            }
        }
        
        async function loadPatientData(rut) {
            let patient = await db.get(STORE_PACIENTES, rut);
            if (!patient) {
                patient = {
                    rut: patientData.rut,
                    nombre: patientData.nombre,
                    autocompleteNames: [...autocompleteNames]
                };
                await db.add(STORE_PACIENTES, patient);
            }
            document.getElementById('patient-name').textContent = patient.nombre;
            document.getElementById('patient-rut').textContent = patient.rut;
            autocompleteNames = patient.autocompleteNames;
        }

        function getDayId(rut, date) {
            const dateKey = date.toISOString().slice(0, 10);
            return `${rut}-${dateKey}`;
        }
        
        async function loadDayData(date) {
            const dayId = getDayId(patientData.rut, date);
            const dayData = await db.get(STORE_DIAS, dayId);
            
            if (dayData) {
                currentDayData = dayData.data;
                customItems = dayData.customItems;
            } else {
                currentDayData = {};
                customItems = { ingresos: [], egresos: [] };
            }
            renderTables();
        }
        
        async function saveData() {
            if (!db) return;
            const dayId = getDayId(patientData.rut, currentDate);
            const dataToSave = {
                id: dayId,
                rutPaciente: patientData.rut,
                fechaInicio: currentDate,
                data: currentDayData,
                customItems: customItems
            };
            
            try {
                await db.put(STORE_DIAS, dataToSave);
            } catch (error) {
                console.error('Error al guardar datos:', error);
            }
        }

        async function saveAutocompleteNames() {
            if (!db) return;
            const patient = await db.get(STORE_PACIENTES, patientData.rut);
            if (patient) {
                patient.autocompleteNames = autocompleteNames;
                await db.put(STORE_PACIENTES, patient);
            }
        }

        // ===============================================
        //  FUNCIÓN PRINCIPAL: RENDERIZAR LA TABLA
        // ===============================================
        function renderTables() {
            // Limpiamos el contenido anterior
            tableBodyEl.innerHTML = '';
            tableHeadersEl.innerHTML = '';

            // Renderizamos los encabezados y filas
            renderHeaders();
            renderRows('ingresos');
            renderSubtotalRow('ingresos'); // Nueva fila de subtotal de ingresos
            renderRows('egresos');
            renderSubtotalRow('egresos'); // Nueva fila de subtotal de egresos
            renderTotalRow();
            
            // Actualizamos el balance total
            updateTotalBalanceDisplay();
        }

        function renderHeaders() {
            // Celda de encabezado fija
            tableHeadersEl.innerHTML += `<th scope="col" class="px-2 py-1 border-r border-gray-200 fixed-col-header">Ítem</th>`;

            // Encabezados de los periodos y totales
            periodos.forEach(periodo => {
                tableHeadersEl.innerHTML += `<th scope="col" class="px-2 py-1 border-r border-gray-200 text-center">
                                    <span>${periodo}</span>
                                  </th>`;
                if (cumulativeCheckpoints.includes(periodo)) {
                    tableHeadersEl.innerHTML += `<th scope="col" class="px-2 py-1 border-r border-gray-200 cumulative-total-column text-center">${cumulativeTitles[periodo]}</th>`;
                }
            });
            // La columna 'Total Día' ha sido eliminada
        }

        function renderRows(type) {
            const itemsBase = type === 'ingresos' ? itemsIngresosBase : itemsEgresosBase;
            const custom = customItems[type];
            const allItems = [...itemsBase, ...custom];
            
            // Fila de título con el icono para añadir
            const titleRow = document.createElement('tr');
            titleRow.className = 'bg-gray-200';
            titleRow.innerHTML = `
                <th class="px-2 py-1 font-bold text-gray-800 border-b border-gray-300 fixed-col-header">
                    <div class="flex items-center justify-between">
                        <span>${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                        <button class="add-item-icon-btn text-gray-600 hover:text-green-500 transition-colors" data-item-type="${type}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </th>
                <td colspan="${periodos.length + cumulativeCheckpoints.length}" class="px-2 py-1 border-b border-gray-300"></td>
            `;
            tableBodyEl.appendChild(titleRow);
            
            allItems.forEach(itemName => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b hover:bg-gray-50';
                
                // Celda de la columna fija
                row.innerHTML = `
                    <th scope="row" class="px-2 py-1 font-medium text-gray-900 border-r border-gray-200 fixed-col-body">
                        <div class="flex items-center justify-between">
                            <span>${itemName}</span>
                            ${!itemsBase.includes(itemName) ? `
                                <button class="delete-row-btn text-red-500 hover:text-red-700 transition-colors" data-item-name="${itemName}" data-item-type="${type}">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>` : ''}
                        </div>
                    </th>
                `;
                
                let cumulativeTotal = 0;
                
                periodos.forEach(periodo => {
                    const cellData = getCellData(periodo, type, itemName);
                    const cell = createEditableCell(type, itemName, periodo, cellData);
                    row.appendChild(cell);
                    cumulativeTotal += cellData.volumen || 0;
                    
                    if (cumulativeCheckpoints.includes(periodo)) {
                        const cumulativeCell = document.createElement('td');
                        cumulativeCell.className = 'px-2 py-1 cumulative-total-column';
                        if (closedCumulativeCheckpoints.includes(periodo)) { 
			    cumulativeCell.textContent = cumulativeTotal >= 0 ? cumulativeTotal : '';
                        }
                        row.appendChild(cumulativeCell);
                    }
                });

                // La celda de "Total Día" se ha eliminado
                tableBodyEl.appendChild(row);
            });
        }

        function renderSubtotalRow(type) {
            const subtotalRow = document.createElement('tr');
            subtotalRow.className = `font-bold ${type === 'ingresos' ? 'subtotal-ingresos-row' : 'subtotal-egresos-row'}`;
            
            subtotalRow.innerHTML = `
                <th scope="row" class="px-2 py-1 border-r border-gray-200 fixed-col-body">Total ${type.charAt(0).toUpperCase() + type.slice(1)}</th>
            `;

            let totalDay = 0;
            let cumulativeTotal = 0;

            periodos.forEach(periodo => {
                const totalPeriodo = calculatePeriodTotals(periodo, type);
                totalDay += totalPeriodo;
                cumulativeTotal += totalPeriodo;

                const subtotalCell = document.createElement('td');
                //subtotalCell.className = 'px-2 py-1 text-center';
                //subtotalCell.textContent = totalPeriodo >= 0 ? totalPeriodo : '';
                subtotalRow.appendChild(subtotalCell);

                if (cumulativeCheckpoints.includes(periodo)) {
                    const cumulativeCell = document.createElement('td');
                    cumulativeCell.className = 'px-2 py-1 subtotal-row-cumulative';
                    if (closedCumulativeCheckpoints.includes(periodo)) { 
                        cumulativeCell.textContent = cumulativeTotal >= 0 ? cumulativeTotal : '';
                    } 
                    subtotalRow.appendChild(cumulativeCell);
                }
            });

            tableBodyEl.appendChild(subtotalRow);
        }

        function renderTotalRow() {
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            
            // Celda de la columna fija
            totalRow.innerHTML = `<th scope="row" class="px-2 py-1 font-bold text-gray-800 border-r border-gray-200 bg-gray-100 fixed-col-body">Balance Hídrico</th>`;

            let cumulativeTotalIngresos = 0;
            let cumulativeTotalEgresos = 0;

            let totalDayIngresos = 0;
            let totalDayEgresos = 0;

            periodos.forEach(periodo => {
                const totalPeriodoIngresos = calculatePeriodTotals(periodo, 'ingresos');
                const totalPeriodoEgresos = calculatePeriodTotals(periodo, 'egresos');

                const totalCell = document.createElement('td');
                totalCell.className = 'px-2 py-1 font-bold text-gray-800 border-r border-gray-200 text-center';
                //const balancePeriodo = totalPeriodoIngresos - totalPeriodoEgresos;
                //totalCell.innerHTML = `
                //    <div class="mt-1 ${balancePeriodo >= 0 ? 'text-green-700' : 'text-red-700'}">${balancePeriodo !== 0 ? balancePeriodo : '0'}</div>
                //`;
                totalRow.appendChild(totalCell);
                
                totalDayIngresos += totalPeriodoIngresos;
                totalDayEgresos += totalPeriodoEgresos;
                
                // Actualizamos los totales acumulados para el balance
                cumulativeTotalIngresos += totalPeriodoIngresos;
                cumulativeTotalEgresos += totalPeriodoEgresos;

                if (cumulativeCheckpoints.includes(periodo)) {
                    const cumulativeCell = document.createElement('td');
                    cumulativeCell.className = 'px-2 py-1 total-row-cumulative';
                    if (closedCumulativeCheckpoints.includes(periodo)) {                    
                        const balanceAcumulado = cumulativeTotalIngresos - cumulativeTotalEgresos;
                        cumulativeCell.innerHTML = `
                            <div class="mt-1 ${balanceAcumulado >= 0 ? 'text-blue-700' : 'text-red-700'}">${balanceAcumulado !== 0 ? balanceAcumulado : '0'}</div>
                        `;
                    }
                    totalRow.appendChild(cumulativeCell);
                }
            });
            
            // La celda de "Total Día" se ha eliminado
            tableBodyEl.appendChild(totalRow);
        }

        // ===============================================
        //  FUNCIONES DE INTERACCIÓN DE CELDAS
        // ===============================================
        let editingCell = null;

        function createEditableCell(type, itemName, periodo, cellData) {
            const cell = document.createElement('td');
            cell.className = `px-2 py-1 border-r border-gray-200 editable-cell`;
            cell.dataset.type = type;
            cell.dataset.periodo = periodo;
            cell.dataset.item = itemName;
            
            const volumen = cellData.volumen || '';

            if (volumen || cellData.comentario || cellData.volumen === 0) {
                cell.innerHTML = `
                    <div class="editable-cell-content">
                        <span class="editable-cell-volume">${cellData.volumen === 0 ? '0' : volumen}</span>
                        <span class="text-gray-500 text-xs">${cellData.comentario ? `(${cellData.comentario})` : ''}</span>
                    </div>
                `;
            } else {
                cell.innerHTML = `<div class="editable-cell-content"></div>`;
            }

            cell.addEventListener('click', (e) => {
                if (editingCell === cell) return;
                if (editingCell) {
                    saveAndExitEditMode(editingCell);
                }
                editingCell = cell;
                enterEditMode(cell, cellData);
                e.stopPropagation();
            });
            return cell;
        }

        function enterEditMode(cell, data) {
            const volumen = data.volumen === null ? '' : data.volumen;
            cell.innerHTML = `
                <div class="editing-mode">
                    <input type="number" class="w-full p-1 text-xs border rounded-md" value="${volumen}" placeholder="mL">
                    <input type="text" class="w-full p-1 text-xs border rounded-md" value="${data.comentario || ''}" placeholder="Comentario">
                </div>
            `;
            cell.querySelector('input[type="number"]').focus();

            cell.querySelectorAll('input').forEach(input => {
                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        if (!cell.contains(document.activeElement)) {
                            saveAndExitEditMode(cell);
                        }
                    }, 10);
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveAndExitEditMode(cell);
                        e.preventDefault();
                    }
                });
            });
        }
        
        function saveAndExitEditMode(cell) {
            saveCellData(cell);
            exitEditMode(cell);
        }

        function exitEditMode(cell) {
            const periodo = cell.dataset.periodo;
            const type = cell.dataset.type;
            const itemName = cell.dataset.item;
            const cellData = getCellData(periodo, type, itemName);
            
            const volumen = cellData.volumen === null ? '' : cellData.volumen;

            cell.innerHTML = `
                <div class="editable-cell-content">
                    <span class="editable-cell-volume">${volumen}</span>
                    <span class="text-gray-500 text-xs">${cellData.comentario ? `(${cellData.comentario})` : ''}</span>
                </div>
            `;
            editingCell = null;
        }

        function saveCellData(cell) {
            const volumenInput = cell.querySelector('input[type="number"]');
            const comentarioInput = cell.querySelector('input[type="text"]');
            
            // Añadimos una verificación para asegurar que los elementos input existan.
            // Si la celda ya no está en modo de edición, salimos de la función.
            if (!volumenInput || !comentarioInput) {
                return;
            }

            const periodo = cell.dataset.periodo;
            const type = cell.dataset.type;
            const itemName = cell.dataset.item;

            if (!currentDayData[periodo]) {
                currentDayData[periodo] = { ingresos: {}, egresos: {} };
            }
            const dataPeriodo = currentDayData[periodo][type];
            if (!dataPeriodo[itemName]) {
                dataPeriodo[itemName] = { volumen: null, comentario: '' };
            }

            dataPeriodo[itemName].volumen = volumenInput.value ? parseInt(volumenInput.value) : null;
            dataPeriodo[itemName].comentario = comentarioInput.value || '';

            // Se intenta poner icono de guardado (ticket) que luego desaparece, sin embargo al renderizar tabla, desaparce
            const confirmationIcon = document.createElement('span');
            confirmationIcon.className = 'save-confirmation';
            confirmationIcon.innerHTML = '&#10003;';
            cell.appendChild(confirmationIcon);
            setTimeout(() => {
                confirmationIcon.remove();
            }, 1000);

            renderTables();
            saveData();
        }

        // ===============================================
        //  FUNCIONES DE GESTIÓN DE DATOS Y TOTALES
        // ===============================================
        function getCellData(periodo, type, itemName) {
            return currentDayData[periodo]?.[type]?.[itemName] || { volumen: null, comentario: '' };
        }

        function calculatePeriodTotals(periodo, type) {
            let total = 0;
            const dataPeriodo = currentDayData[periodo] || {};
            const items = type === 'ingresos' ? [...itemsIngresosBase, ...customItems.ingresos] : [...itemsEgresosBase, ...customItems.egresos];
            
            items.forEach(itemName => {
                total += dataPeriodo[type]?.[itemName]?.volumen || 0;
            });
            return total;
        }
        
        function calculateItemTotal(type, itemName) {
            let total = 0;
            periodos.forEach(periodo => {
                total += currentDayData[periodo]?.[type]?.[itemName]?.volumen || 0;
            });
            return total;
        }

        function updateTotalBalanceDisplay() {
            let totalIngresos = 0;
            let totalEgresos = 0;
            if (closedCumulativeCheckpoints.includes("07:00")) {                    
                periodos.forEach(periodo => {
                    totalIngresos += calculatePeriodTotals(periodo, 'ingresos');
                    totalEgresos += calculatePeriodTotals(periodo, 'egresos');
                });
                const balance = totalIngresos - totalEgresos;
                totalBalanceDisplay.textContent = balance !== 0 ? balance : '0';
                totalBalanceDisplay.className = `text-md font-bold mt-1 ${balance >= 0 ? 'text-blue-700' : 'text-red-700'}`;
            }
        }

        // ===============================================
        //  MANEJO DE FECHA Y NAVEGACIÓN
        // ===============================================
        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: '2-digit' };
            return date.toLocaleDateString('es-ES', options);
        }

        function updateDateDisplay() {
            const dateStart = new Date(currentDate);
            const dateEnd = new Date(currentDate);
            dateEnd.setDate(dateStart.getDate() + 1);
            dateRangeEl.textContent = `${formatDate(dateStart)} 08:00 - ${formatDate(dateEnd)} 07:00`;
        }

        async function updateDay() {
            updateDateDisplay();
            await loadDayData(currentDate);
        }
        
        // ===============================================
        //  INICIALIZACIÓN
        // ===============================================
        async function initialize() {
            document.getElementById('patient-name').textContent = patientData.nombre;
            document.getElementById('patient-rut').textContent = patientData.rut;
            updateDateDisplay();
            await initDB();
            await loadPatientData(patientData.rut);
            await updateDay();
        }
        
        document.addEventListener('click', (e) => {
            // Manejar click en el nuevo botón de ícono
            const addItemIconBtn = e.target.closest('.add-item-icon-btn');
            if (addItemIconBtn) {
                openAddRowModal(addItemIconBtn.dataset.itemType);
            }
            
            const deleteRowBtn = e.target.closest('.delete-row-btn');
            if (deleteRowBtn) {
                openDeleteRowModal(deleteRowBtn.dataset.itemName, deleteRowBtn.dataset.itemType);
            }
        });

        document.getElementById('add-row-confirm-btn').addEventListener('click', async () => {
            const newRowName = addRowNameInput.value.trim();
            if (!newRowName) return;

            const customItemsArray = customItems[currentAddRowType];
            if (!customItemsArray.includes(newRowName)) {
                customItemsArray.push(newRowName);
            }
            
            if (!autocompleteNames.includes(newRowName)) {
                autocompleteNames.push(newRowName);
                await saveAutocompleteNames();
            }

            closeModal(addRowModal);
            renderTables();
            await saveData();
        });

        document.getElementById('add-row-cancel-btn').addEventListener('click', () => closeModal(addRowModal));
        document.getElementById('delete-row-cancel-btn').addEventListener('click', () => closeModal(deleteRowModal));

        document.getElementById('delete-row-confirm-btn').addEventListener('click', async () => {
            const customItemsArray = customItems[rowToDelete.type];
            customItems[rowToDelete.type] = customItemsArray.filter(item => item !== rowToDelete.name);
            
            periodos.forEach(periodo => {
                if (currentDayData[periodo]?.[rowToDelete.type]) {
                    delete currentDayData[periodo][rowToDelete.type][rowToDelete.name];
                }
            });
            
            closeModal(deleteRowModal);
            renderTables();
            await saveData();
        });
        
        addRowNameInput.addEventListener('input', () => {
            const inputVal = addRowNameInput.value.toLowerCase();
            autocompleteList.innerHTML = '';
            if (inputVal) {
                const filteredNames = autocompleteNames.filter(name => 
                    name.toLowerCase().includes(inputVal)
                );
                if (filteredNames.length) {
                    autocompleteList.classList.remove('hidden');
                    filteredNames.forEach(name => {
                        const li = document.createElement('li');
                        li.className = 'px-4 py-2 cursor-pointer hover:bg-gray-100';
                        li.textContent = name;
                        li.addEventListener('click', () => {
                            addRowNameInput.value = name;
                            autocompleteList.classList.add('hidden');
                        });
                        autocompleteList.appendChild(li);
                    });
                } else {
                    autocompleteList.classList.add('hidden');
                }
            } else {
                autocompleteList.classList.add('hidden');
            }
        });
        
        document.addEventListener('click', (e) => {
            if (!addRowNameInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        prevDayBtn.addEventListener('click', async () => {
            currentDate.setDate(currentDate.getDate() - 1);
            await updateDay();
        });

        nextDayBtn.addEventListener('click', async () => {
            currentDate.setDate(currentDate.getDate() + 1);
            await updateDay();
        });

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
